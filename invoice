cat << 'EOF' > ~/garage/invoice
#!/usr/bin/env python3
"""
GOOD 'NUFF GARAGE - Simple Invoice Builder

- Loads customers from:
    /home/goodnuffmechanic/garage/.business/customers/customers.csv
- Logs invoice summary to:
    /home/goodnuffmechanic/garage/.business/invoices/invoices.csv
- Writes human-readable invoice to:
    ~/Outgoing/INVOICE_YYYYMMDD_HHMMSS.txt
    ~/Outgoing/INVOICE_YYYYMMDD_HHMMSS.html
"""

import csv
from pathlib import Path
from datetime import datetime
from decimal import Decimal, ROUND_HALF_UP

HOME = Path("/home/goodnuffmechanic")
BUSINESS = HOME / "garage" / ".business"
CUSTOMERS_CSV = BUSINESS / "customers" / "customers.csv"
INVOICE_LOG = BUSINESS / "invoices" / "invoices.csv"
OUTGOING = HOME / "Outgoing"

TAX_RATE = Decimal("0.07")  # 7% parts tax; change later if needed


def money(x: Decimal) -> Decimal:
    return x.quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)


def load_customers():
    rows = []
    if not CUSTOMERS_CSV.exists():
        return rows
    try:
        with CUSTOMERS_CSV.open(newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                rows.append(row)
    except Exception as e:
        print("\nERROR loading customers.csv:", e)
    return rows


def choose_customer():
    rows = load_customers()
    if not rows:
        print("\nNo customers found in the system yet.")
        print("You can still create an invoice as a walk-in.\n")
        input("Press Enter to continue...")
        return None  # walk-in only

    while True:
        print("\n=== INVOICE CUSTOMER SELECTION ===")
        print("1) Pick existing customer")
        print("2) Walk-in / one-off customer")
        print("3) Cancel\n")
        choice = input("Select: ").strip()
        if choice == "1":
            print("\n=== Customers ===")
            for i, r in enumerate(rows, start=1):
                name = r.get("name", "")
                vehicle = r.get("vehicle", "")
                phone = r.get("phone", "")
                line = f"{i}) {name}"
                if vehicle:
                    line += f" — {vehicle}"
                if phone:
                    line += f" — {phone}"
                print(line)
            print()
            pick = input("Choose customer # (or Enter to cancel): ").strip()
            if not pick:
                continue
            if not pick.isdigit() or not (1 <= int(pick) <= len(rows)):
                print("Invalid selection. Try again.\n")
                continue
            return rows[int(pick) - 1]
        elif choice == "2":
            return None
        elif choice == "3":
            return "CANCEL"
        else:
            print("Invalid choice.\n")


def input_decimal(prompt: str) -> Decimal:
    while True:
        raw = input(prompt).strip()
        if raw == "":
            return Decimal("0.00")
        try:
            return Decimal(raw)
        except Exception:
            print("Invalid number. Try again (e.g., 90 or 45.5).")


def collect_line_items():
    print("\n=== LINE ITEMS ===")
    print("Enter each line. Leave description blank when finished.\n")
    items = []
    while True:
        desc = input("Description (or blank to finish): ").strip()
        if desc == "":
            break
        cat_raw = input("Category [labor/parts] (default labor): ").strip().lower()
        category = "parts" if cat_raw == "parts" else "labor"
        amount = input_decimal("Amount for this line (e.g., 90 or 45.5): ")
        items.append(
            {
                "description": desc,
                "category": category,
                "amount": money(amount),
            }
        )
        print("Added.\n")
    if not items:
        print("No line items entered; you will still get an invoice shell.\n")
    return items


def ensure_invoice_log_exists():
    """Make sure invoice summary CSV has headers."""
    if INVOICE_LOG.exists():
        return
    INVOICE_LOG.parent.mkdir(parents=True, exist_ok=True)
    with INVOICE_LOG.open("w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(
            f,
            fieldnames=[
                "invoice_no",
                "created_at",
                "customer_id",
                "customer_name",
                "vehicle",
                "labor_total",
                "parts_total",
                "tax",
                "grand_total",
                "status",
                "payment_method",
            ],
        )
        writer.writeheader()


def append_invoice_log(row: dict):
    ensure_invoice_log_exists()
    with INVOICE_LOG.open("a", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=row.keys())
        writer.writerow(row)


def build_invoice_text(invoice_no, created_at, cust, vehicle, items, labor_total,
                       parts_total, tax, grand_total, status, payment_method, notes):
    lines = []
    lines.append("GOOD 'NUFF MOBILE MECHANIC")
    lines.append("Asheville, North Carolina")
    lines.append("Phone: (828) 974-1684")
    lines.append("Email: goodnuffmechanic@gmail.com")
    lines.append("-" * 60)
    lines.append(f"Invoice #: {invoice_no}")
    lines.append(f"Date:    {created_at}")
    lines.append(f"Status:  {status}")
    lines.append(f"Paid via: {payment_method}")
    lines.append("-" * 60)

    if cust:
        lines.append("BILL TO:")
        lines.append(f"  Name:   {cust.get('name', '')}")
        phone = cust.get("phone", "")
        if phone:
            lines.append(f"  Phone:  {phone}")
        email = cust.get("email", "")
        if email:
            lines.append(f"  Email:  {email}")
    else:
        lines.append("BILL TO: Walk-in / one-off customer")
    lines.append("")
    if vehicle:
        lines.append(f"Vehicle: {vehicle}")
    else:
        lines.append("Vehicle: (not specified)")
    lines.append("-" * 60)
    lines.append("DESCRIPTION".ljust(40) + "TYPE".ljust(10) + "AMOUNT")
    lines.append("-" * 60)

    if items:
        for it in items:
            desc = it["description"][:38]
            cat = it["category"]
            amt = f"${it['amount']}"
            lines.append(desc.ljust(40) + cat.ljust(10) + amt.rjust(10))
    else:
        lines.append("(no line items entered)")

    lines.append("-" * 60)
    lines.append(f"Labor total:           ${labor_total}")
    lines.append(f"Parts total:           ${parts_total}")
    lines.append(f"Tax on parts ({TAX_RATE*100}%): ${tax}")
    lines.append("-" * 60)
    lines.append(f"GRAND TOTAL:           ${grand_total}")
    lines.append("-" * 60)
    if notes:
        lines.append("Notes:")
        lines.append(notes)
        lines.append("-" * 60)

    lines.append("Thank you for your business!")
    return "\n".join(lines)


def main():
    OUTGOING.mkdir(parents=True, exist_ok=True)

    cust = choose_customer()
    if cust == "CANCEL":
        print("Invoice cancelled.")
        return

    print("\n=== BASIC JOB INFO ===")
    default_vehicle = cust.get("vehicle", "") if cust else ""
    vehicle = input(f"Vehicle [{default_vehicle}]: ").strip()
    if not vehicle:
        vehicle = default_vehicle

    notes = input("Job description / notes (optional): ").strip()

    items = collect_line_items()

    labor_total = money(
        sum(it["amount"] for it in items if it["category"] == "labor")
    )
    parts_total = money(
        sum(it["amount"] for it in items if it["category"] == "parts")
    )
    tax = money(parts_total * TAX_RATE)
    grand_total = money(labor_total + parts_total + tax)

    status_raw = input("Status [PAID/UNPAID] (default UNPAID): ").strip().upper()
    status = status_raw if status_raw in ("PAID", "UNPAID") else "UNPAID"
    payment_method = input("Payment method (cash/card/app/etc): ").strip() or "N/A"

    now = datetime.now()
    created_at = now.strftime("%Y-%m-%d %H:%M:%S")
    invoice_no = "GN-" + now.strftime("%Y%m%d-%H%M%S")

    # Build text invoice
    text_body = build_invoice_text(
        invoice_no,
        created_at,
        cust,
        vehicle,
        items,
        labor_total,
        parts_total,
        tax,
        grand_total,
        status,
        payment_method,
        notes,
    )

    # File names
    base_name = f"{invoice_no}".replace(":", "").replace(" ", "_")
    txt_path = OUTGOING / f"{base_name}.txt"
    html_path = OUTGOING / f"{base_name}.html"

    txt_path.write_text(text_body, encoding="utf-8")

    html_body = (
        "<!DOCTYPE html><html><head><meta charset='utf-8'>"
        f"<title>{invoice_no}</title>"
        "</head><body><pre>"
        + text_body.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")
        + "</pre></body></html>"
    )
    html_path.write_text(html_body, encoding="utf-8")

    # Log summary row
    log_row = {
        "invoice_no": invoice_no,
        "created_at": created_at,
        "customer_id": cust.get("customer_id", "") if cust else "",
        "customer_name": cust.get("name", "") if cust else "",
        "vehicle": vehicle,
        "labor_total": str(labor_total),
        "parts_total": str(parts_total),
        "tax": str(tax),
        "grand_total": str(grand_total),
        "status": status,
        "payment_method": payment_method,
    }
    append_invoice_log(log_row)

    print("\nInvoice created!")
    print(f"Text copy : {txt_path}")
    print(f"HTML copy : {html_path}")
    print("\nOpen the HTML file in ChromeOS and Print → Save as PDF.\n")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nInvoice cancelled by user.\n")
EOF