<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light only" />
  <title>Good ’Nuff Invoice</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#111827;
      --good:#065f46;
      --bad:#7f1d1d;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius: 14px;
      --pad: 16px;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:var(--bg);
    }

    .wrap{
      max-width: 980px;
      margin: 18px auto 90px;
      padding: 0 14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brandline{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .brandline h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .brandline .sub{
      font-size: 12px;
      color:var(--muted);
    }

    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    .pill strong{ font-weight:700; }
    .statusDot{
      width:10px;height:10px;border-radius:99px;
      background: var(--bad);
      display:inline-block;
    }
    .statusDot.paid{ background: var(--good); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 820px){
      .grid{
        grid-template-columns: 1.1fr .9fr;
        align-items:start;
      }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }

    .card h2{
      margin:0 0 10px;
      font-size: 14px;
      letter-spacing:.2px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media(min-width: 520px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12px;
      color: var(--muted);
    }

    input, textarea, select{
      font: inherit;
      font-size: 14px;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      outline: none;
      background:#fff;
      color: var(--ink);
    }

    textarea{ min-height: 86px; resize: vertical; }

    input:focus, textarea:focus, select:focus{
      border-color:#c7cdd6;
      box-shadow: 0 0 0 3px rgba(17,24,39,.06);
    }

    .mutedNote{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      border-top:1px dashed var(--line);
      padding-top: 12px;
      margin-top: 12px;
    }
    .kv div{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 7px 0;
      font-size: 14px;
    }
    .kv div span:first-child{ color: var(--muted); }
    .kv .total{
      font-weight: 800;
      font-size: 18px;
      padding-top: 10px;
      border-top:1px solid var(--line);
      margin-top: 6px;
    }

    .itemsHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }

    .smallbtn{
      border:1px solid var(--line);
      background:#fff;
      color: var(--ink);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor:pointer;
      touch-action: manipulation;
    }
    .smallbtn:active{ transform: translateY(1px); }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
    }

    thead th{
      text-align:left;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      padding: 10px 10px;
      border-bottom:1px solid var(--line);
      background: #fbfcfe;
    }

    tbody td{
      padding: 8px 10px;
      border-bottom:1px solid var(--line);
      vertical-align: top;
    }

    tbody tr:last-child td{ border-bottom: none; }

    .tdNum{ width: 86px; }
    .tdRate{ width: 110px; }
    .tdTotal{ width: 120px; text-align:right; font-variant-numeric: tabular-nums; }
    .tdAct{ width: 60px; text-align:right; }

    .cellInput{
      width:100%;
      padding: 8px 9px;
      border-radius: 10px;
      border:1px solid var(--line);
      font-size: 14px;
    }

    .cellInput.small{
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

    .removeBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      touch-action: manipulation;
    }

    .right{
      display:flex;
      justify-content:flex-end;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 6px;
    }
    .toggle input{ width: 18px; height: 18px; }

    .footerBar{
      position: fixed;
      left:0; right:0; bottom:0;
      background: rgba(246,247,249,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      padding: 10px 12px;
    }
    .footerInner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }

    .btnRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color: var(--ink);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
    }
    .btn.primary{
      background: var(--accent);
      color:#fff;
      border-color: var(--accent);
    }
    .btn.danger{
      border-color:#f1c7c7;
      background:#fff5f5;
      color:#7f1d1d;
    }
    .btn:active{ transform: translateY(1px); }

    .saveState{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .readonlyBox{
      font-size: 12px;
      color: var(--muted);
      background: #fbfcfe;
      border:1px solid var(--line);
      border-radius: 10px;
      padding: 10px 10px;
      user-select: text;
    }

    /* Print */
    @media print{
      body{ background:#fff; }
      .wrap{ margin:0; padding:0; max-width: none; }
      .card{ box-shadow:none; border: none; border-radius: 0; padding: 0; }
      .footerBar{ display:none !important; }
      .smallbtn, .removeBtn{ display:none !important; }
      input, textarea, select{ border: none; padding: 0; }
      table{ border:1px solid #ddd; }
      thead th{ background: #f5f5f5; }
      .topbar{ margin-bottom: 10px; }
      .readonlyBox{ border:none; padding:0; background:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brandline">
        <h1>Good ’Nuff Mobile Mechanic — Invoice</h1>
        <div class="sub">Professional shop-grade invoice • Print-ready • Draft autosave</div>
      </div>

      <div class="pill" title="Status will always reopen as UNPAID when you reload the page.">
        <span id="statusDot" class="statusDot"></span>
        <strong id="statusText">UNPAID</strong>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: MAIN -->
      <div class="card">
        <h2>Invoice details</h2>

        <div class="row two">
          <label>
            Business name
            <input id="bizName" type="text" value="Good ’Nuff Mobile Mechanic" />
          </label>
          <label>
            Business phone / email
            <input id="bizContact" type="text" value="(XXX) XXX-XXXX • youremail@example.com" />
          </label>
        </div>

        <div class="row two">
          <label>
            Invoice #
            <input id="invoiceNo" type="text" placeholder="GOODNUFF-2026-0001" />
          </label>
          <label>
            Invoice date
            <input id="invoiceDate" type="date" />
          </label>
        </div>

        <div class="row two">
          <label>
            Customer name
            <input id="custName" type="text" placeholder="Customer full name" />
          </label>
          <label>
            Customer phone
            <input id="custPhone" type="text" placeholder="(###) ###-####" />
          </label>
        </div>

        <div class="row two">
          <label>
            Customer email (optional)
            <input id="custEmail" type="email" placeholder="email@example.com" />
          </label>
          <label>
            Job location (optional)
            <input id="jobLocation" type="text" placeholder="Address / parking lot / job site" />
          </label>
        </div>

        <div class="row three">
          <label>
            Vehicle year (optional)
            <input id="vehYear" type="text" placeholder="2017" />
          </label>
          <label>
            Make / Model (optional)
            <input id="vehModel" type="text" placeholder="Ford Focus SEL" />
          </label>
          <label>
            VIN (optional)
            <input id="vehVIN" type="text" placeholder="VIN" />
          </label>
        </div>

        <label>
          Notes (optional)
          <textarea id="notes" placeholder="Work performed, warranty notes, payment terms, etc."></textarea>
        </label>

        <div class="itemsHeader" style="margin-top:14px;">
          <h2 style="margin:0;">Line items</h2>
          <button class="smallbtn" id="addItemBtn" type="button">+ Add line</button>
        </div>

        <table aria-label="Line items">
          <thead>
            <tr>
              <th class="tdNum">Qty/Hrs</th>
              <th>Description</th>
              <th class="tdRate">Rate</th>
              <th class="tdTotal">Line total</th>
              <th class="tdAct"></th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>

        <div class="mutedNote">
          Tip is disabled (by design). Tax is a toggle on the right panel.
        </div>
      </div>

      <!-- RIGHT: TOTALS / SETTINGS -->
      <div class="card">
        <h2>Totals & settings</h2>

        <div class="readonlyBox">
          <div><strong>Draft behavior:</strong> This page auto-loads your last draft on open.</div>
          <div>PAID status always reopens as <strong>UNPAID</strong> (even if you marked it paid before).</div>
        </div>

        <div class="toggle">
          <input id="taxToggle" type="checkbox" />
          <label style="margin:0; gap:4px;">
            Apply NC sales tax
            <span class="sub" style="font-size:12px;color:var(--muted);">Default rate: 7%</span>
          </label>
        </div>

        <div class="row two" style="margin-top:10px;">
          <label>
            Tax rate (%)
            <input id="taxRate" type="number" step="0.01" min="0" value="7" />
          </label>
          <label>
            Status (manual)
            <select id="paidSelect">
              <option value="unpaid" selected>UNPAID</option>
              <option value="paid">PAID</option>
            </select>
          </label>
        </div>

        <div class="kv" style="margin-top:14px;">
          <div><span>Subtotal</span><span id="subtotalOut">$0.00</span></div>
          <div><span>Tax</span><span id="taxOut">$0.00</span></div>
          <div class="total"><span>Total due</span><span id="totalOut">$0.00</span></div>
        </div>

        <div class="mutedNote">
          Export CSV is for bookkeeping/taxes. Print uses iPhone “Share → Print → Save as PDF”.
        </div>
      </div>
    </div>
  </div>

  <!-- ACTION BAR -->
  <div class="footerBar" role="contentinfo">
    <div class="footerInner">
      <div class="btnRow">
        <button class="btn primary" id="recalcBtn" type="button">Recalculate</button>
        <button class="btn" id="printBtn" type="button">Print / Save PDF</button>
        <button class="btn" id="csvBtn" type="button">Export CSV</button>
        <button class="btn" id="saveBtn" type="button">Save Draft</button>
        <button class="btn danger" id="clearBtn" type="button">Clear Draft</button>
      </div>

      <div class="saveState">
        <span id="draftState">Draft: not saved yet</span>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    // ====== SETTINGS ======
    const DRAFT_KEY = "goodnuff_invoice_draft_v1";
    const DEFAULT_TAX_RATE = 7; // percent
    const DEFAULT_INVOICE_PREFIX = "GOODNUFF-2026-";

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);

    function money(n){
      const v = Number(n || 0);
      return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(v);
    }

    function num(v){
      const x = Number(String(v).replace(/[^0-9.\-]/g,""));
      return Number.isFinite(x) ? x : 0;
    }

    function todayISO(){
      const d = new Date();
      const pad = (x) => String(x).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function setDraftState(msg){
      $("draftState").textContent = msg;
    }

    function setStatus(paid){
      // UI only; remember: we ALWAYS reopen as UNPAID on load
      const dot = $("statusDot");
      const txt = $("statusText");
      if (paid){
        dot.classList.add("paid");
        txt.textContent = "PAID";
      } else {
        dot.classList.remove("paid");
        txt.textContent = "UNPAID";
      }
    }

    // ====== LINE ITEM ROWS ======
    function makeRow(item = {}){
      const tr = document.createElement("tr");

      const tdQty = document.createElement("td");
      tdQty.className = "tdNum";
      const qty = document.createElement("input");
      qty.className = "cellInput small";
      qty.type = "number";
      qty.step = "0.1";
      qty.min = "0";
      qty.value = (item.qty ?? 1);
      qty.setAttribute("inputmode","decimal");
      tdQty.appendChild(qty);

      const tdDesc = document.createElement("td");
      const desc = document.createElement("input");
      desc.className = "cellInput";
      desc.type = "text";
      desc.placeholder = "Diagnostics, labor, parts, etc.";
      desc.value = (item.desc ?? "");
      tdDesc.appendChild(desc);

      const tdRate = document.createElement("td");
      tdRate.className = "tdRate";
      const rate = document.createElement("input");
      rate.className = "cellInput small";
      rate.type = "number";
      rate.step = "0.01";
      rate.min = "0";
      rate.value = (item.rate ?? 90);
      rate.setAttribute("inputmode","decimal");
      tdRate.appendChild(rate);

      const tdTotal = document.createElement("td");
      tdTotal.className = "tdTotal";
      const total = document.createElement("div");
      total.textContent = money((num(qty.value) * num(rate.value)));
      tdTotal.appendChild(total);

      const tdAct = document.createElement("td");
      tdAct.className = "tdAct";
      const rm = document.createElement("button");
      rm.className = "removeBtn";
      rm.type = "button";
      rm.textContent = "✕";
      rm.title = "Remove line";
      tdAct.appendChild(rm);

      // Live recalc on input (simple, stable)
      const onChange = () => {
        total.textContent = money(num(qty.value) * num(rate.value));
        recalcTotals(false);
      };
      qty.addEventListener("input", onChange, {passive:true});
      rate.addEventListener("input", onChange, {passive:true});
      desc.addEventListener("input", () => { /* no math */ }, {passive:true});

      rm.addEventListener("click", () => {
        tr.remove();
        recalcTotals(false);
      });

      tr.appendChild(tdQty);
      tr.appendChild(tdDesc);
      tr.appendChild(tdRate);
      tr.appendChild(tdTotal);
      tr.appendChild(tdAct);

      return tr;
    }

    function addLine(item){
      $("itemsBody").appendChild(makeRow(item));
      recalcTotals(false);
    }

    function getLines(){
      const rows = Array.from($("itemsBody").querySelectorAll("tr"));
      return rows.map(r => {
        const inputs = r.querySelectorAll("input");
        const qty = num(inputs[0].value);
        const desc = String(inputs[1].value || "").trim();
        const rate = num(inputs[2].value);
        return { qty, desc, rate };
      });
    }

    // ====== TOTALS ======
    function recalcTotals(markSavedState=true){
      const items = getLines();
      const subtotal = items.reduce((sum,it)=> sum + (num(it.qty)*num(it.rate)), 0);

      const taxOn = $("taxToggle").checked;
      const ratePct = num($("taxRate").value || DEFAULT_TAX_RATE);
      const tax = taxOn ? (subtotal * (ratePct/100)) : 0;

      const total = subtotal + tax;

      $("subtotalOut").textContent = money(subtotal);
      $("taxOut").textContent = money(tax);
      $("totalOut").textContent = money(total);

      // Status display from dropdown (but note: on load we force UNPAID)
      setStatus($("paidSelect").value === "paid");

      if(markSavedState){
        setDraftState("Draft: changes not saved");
      }
    }

    // ====== DRAFT SAVE/LOAD (AUTO-LOAD ON OPEN) ======
    function collectDraft(){
      return {
        v: 1,
        bizName: $("bizName").value,
        bizContact: $("bizContact").value,
        invoiceNo: $("invoiceNo").value,
        invoiceDate: $("invoiceDate").value,
        custName: $("custName").value,
        custPhone: $("custPhone").value,
        custEmail: $("custEmail").value,
        jobLocation: $("jobLocation").value,
        vehYear: $("vehYear").value,
        vehModel: $("vehModel").value,
        vehVIN: $("vehVIN").value,
        notes: $("notes").value,
        taxToggle: $("taxToggle").checked,
        taxRate: $("taxRate").value,
        // IMPORTANT: do NOT persist PAID as paid; always reopen unpaid.
        items: getLines()
      };
    }

    function applyDraft(d){
      $("bizName").value = d.bizName ?? $("bizName").value;
      $("bizContact").value = d.bizContact ?? $("bizContact").value;

      $("invoiceNo").value = d.invoiceNo ?? $("invoiceNo").value;
      $("invoiceDate").value = d.invoiceDate ?? $("invoiceDate").value;

      $("custName").value = d.custName ?? "";
      $("custPhone").value = d.custPhone ?? "";
      $("custEmail").value = d.custEmail ?? "";
      $("jobLocation").value = d.jobLocation ?? "";

      $("vehYear").value = d.vehYear ?? "";
      $("vehModel").value = d.vehModel ?? "";
      $("vehVIN").value = d.vehVIN ?? "";

      $("notes").value = d.notes ?? "";

      $("taxToggle").checked = !!d.taxToggle;
      $("taxRate").value = (d.taxRate ?? DEFAULT_TAX_RATE);

      // ALWAYS reopen as UNPAID:
      $("paidSelect").value = "unpaid";
      setStatus(false);

      // Replace items
      $("itemsBody").innerHTML = "";
      const items = Array.isArray(d.items) ? d.items : [];
      if(items.length){
        items.forEach(it => addLine(it));
      } else {
        addLine({qty:1, desc:"", rate:90});
      }

      recalcTotals(false);
      setDraftState("Draft: auto-loaded");
    }

    function saveDraft(){
      try{
        const d = collectDraft();
        localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
        setDraftState("Draft: saved");
      }catch(e){
        alert("Could not save draft. (Storage may be full or blocked.)");
      }
    }

    function loadDraftIfExists(){
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return false;
        const d = JSON.parse(raw);

        // Basic safety: ignore if not object
        if(!d || typeof d !== "object") return false;

        applyDraft(d);
        return true;
      }catch(e){
        // If draft is corrupted, don't brick the app
        return false;
      }
    }

    function clearDraft(){
      if(!confirm("Clear the saved draft and reset this invoice?")) return;
      localStorage.removeItem(DRAFT_KEY);

      // Reset fields
      $("custName").value = "";
      $("custPhone").value = "";
      $("custEmail").value = "";
      $("jobLocation").value = "";
      $("vehYear").value = "";
      $("vehModel").value = "";
      $("vehVIN").value = "";
      $("notes").value = "";

      $("taxToggle").checked = false;
      $("taxRate").value = DEFAULT_TAX_RATE;

      // Always unpaid
      $("paidSelect").value = "unpaid";
      setStatus(false);

      // Keep business identity but allow edits
      // Leave invoice number/date (we'll initialize below if blank)

      $("itemsBody").innerHTML = "";
      addLine({qty:1, desc:"", rate:90});

      // Mark unsaved state then save a clean draft
      recalcTotals(true);
      setDraftState("Draft: cleared (not saved)");
    }

    // ====== CSV EXPORT ======
    function exportCSV(){
      const lines = getLines();
      const taxOn = $("taxToggle").checked;
      const taxRate = num($("taxRate").value || DEFAULT_TAX_RATE);

      // Compute totals
      const subtotal = lines.reduce((sum,it)=> sum + (num(it.qty)*num(it.rate)), 0);
      const tax = taxOn ? (subtotal * (taxRate/100)) : 0;
      const total = subtotal + tax;

      const header = [
        "InvoiceNo","InvoiceDate","BusinessName","BusinessContact",
        "CustomerName","CustomerPhone","CustomerEmail","JobLocation",
        "VehicleYear","VehicleModel","VehicleVIN",
        "TaxEnabled","TaxRatePct",
        "LineQty","LineDesc","LineRate","LineTotal",
        "Subtotal","Tax","Total"
      ];

      const rows = [];
      for(const it of lines){
        const lineTotal = num(it.qty) * num(it.rate);
        rows.push([
          $("invoiceNo").value,
          $("invoiceDate").value,
          $("bizName").value,
          $("bizContact").value,
          $("custName").value,
          $("custPhone").value,
          $("custEmail").value,
          $("jobLocation").value,
          $("vehYear").value,
          $("vehModel").value,
          $("vehVIN").value,
          taxOn ? "YES" : "NO",
          String(taxRate),
          String(it.qty),
          it.desc?.replaceAll('"','""') ?? "",
          String(it.rate),
          String(lineTotal.toFixed(2)),
          String(subtotal.toFixed(2)),
          String(tax.toFixed(2)),
          String(total.toFixed(2))
        ]);
      }

      const csv = [
        header.join(","),
        ...rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(","))
      ].join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const safeNo = ($("invoiceNo").value || "invoice").replace(/[^\w\-]+/g,"_");
      a.href = url;
      a.download = `${safeNo}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== INIT ======
    function init(){
      // Date default
      if(!$("invoiceDate").value) $("invoiceDate").value = todayISO();

      // Invoice # default if blank
      if(!$("invoiceNo").value){
        $("invoiceNo").value = DEFAULT_INVOICE_PREFIX + "0001";
      }

      // Always reopen unpaid
      $("paidSelect").value = "unpaid";
      setStatus(false);

      // Start with one line
      addLine({qty:1, desc:"", rate:90});

      // Try auto-load draft
      const loaded = loadDraftIfExists();
      if(!loaded){
        recalcTotals(false);
        setDraftState("Draft: none found (start a new invoice)");
      }

      // Bind actions
      $("addItemBtn").addEventListener("click", () => addLine({qty:1, desc:"", rate:90}));
      $("recalcBtn").addEventListener("click", () => recalcTotals(true));
      $("printBtn").addEventListener("click", () => window.print());
      $("csvBtn").addEventListener("click", () => { recalcTotals(false); exportCSV(); });
      $("saveBtn").addEventListener("click", () => saveDraft());
      $("clearBtn").addEventListener("click", () => clearDraft());

      $("taxToggle").addEventListener("change", () => recalcTotals(true));
      $("taxRate").addEventListener("input", () => recalcTotals(true));

      $("paidSelect").addEventListener("change", () => {
        // Visual only; NOT persisted as paid on load.
        setStatus($("paidSelect").value === "paid");
        setDraftState("Draft: changes not saved");
      });

      // Mark draft dirty when editing main fields
      const dirtyIds = [
        "bizName","bizContact","invoiceNo","invoiceDate",
        "custName","custPhone","custEmail","jobLocation",
        "vehYear","vehModel","vehVIN","notes"
      ];
      dirtyIds.forEach(id => {
        $(id).addEventListener("input", () => setDraftState("Draft: changes not saved"), {passive:true});
      });

      // Optional: quick-save on page hide (helps iPhone multitasking)
      document.addEventListener("visibilitychange", () => {
        if(document.visibilityState === "hidden"){
          // Save draft quietly (still reopens unpaid)
          try{ saveDraft(); }catch(e){}
        }
      });
    }

    // Run after DOM is ready
    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  </script>
</body>
</html>