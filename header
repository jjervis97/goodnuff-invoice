#!/usr/bin/env python3
"""
GOOD 'NUFF VIN HELPER

Quick VIN decoder:
- Validates length & characters
- Checks VIN check digit
- Decodes region, rough manufacturer (for common makes)
- Decodes model year (10th character)
- Shows plant code & serial
- Can suggest NHTSA decode URL

Does NOT pull online data – it's a quick offline decoder.
"""

from pathlib import Path
import sys
import webbrowser

# Colors
RESET  = "\033[0m"
BOLD   = "\033[1m"
RED    = "\033[31m"
GREEN  = "\033[32m"
YELLOW = "\033[33m"
CYAN   = "\033[36m"

# --- VIN helpers ---

# Transliteration for VIN check digit
VIN_MAP = {
    **{str(i): i for i in range(10)},
    "A": 1, "B": 2, "C": 3, "D": 4, "E": 5,
    "F": 6, "G": 7, "H": 8, "J": 1, "K": 2,
    "L": 3, "M": 4, "N": 5, "P": 7, "R": 9,
    "S": 2, "T": 3, "U": 4, "V": 5, "W": 6,
    "X": 7, "Y": 8, "Z": 9,
}

VIN_WEIGHTS = [8, 7, 6, 5, 4, 3, 2, 10, 0, 9, 8, 7, 6, 5, 4, 3, 2]

YEAR_CODES = {
    "A": 1980, "B": 1981, "C": 1982, "D": 1983, "E": 1984, "F": 1985,
    "G": 1986, "H": 1987, "J": 1988, "K": 1989, "L": 1990, "M": 1991,
    "N": 1992, "P": 1993, "R": 1994, "S": 1995, "T": 1996, "V": 1997,
    "W": 1998, "X": 1999, "Y": 2000,
    "1": 2001, "2": 2002, "3": 2003, "4": 2004, "5": 2005,
    "6": 2006, "7": 2007, "8": 2008, "9": 2009,
    # repeats every 30 years:
    "A2": 2010, "B2": 2011, "C2": 2012, "D2": 2013, "E2": 2014,
    "F2": 2015, "G2": 2016, "H2": 2017, "J2": 2018, "K2": 2019,
    "L2": 2020, "M2": 2021, "N2": 2022, "P2": 2023, "R2": 2024,
    "S2": 2025, "T2": 2026, "V2": 2027, "W2": 2028, "X2": 2029,
    "Y2": 2030,
}

REGION_MAP = {
    "1": "USA",
    "2": "Canada",
    "3": "Mexico",
    "4": "USA",
    "5": "USA",
    "J": "Japan",
    "K": "Korea",
    "S": "UK",
    "V": "France / Spain",
    "W": "Germany",
    "Y": "Nordic (Sweden/Finland)",
    "Z": "Italy",
}

# Very rough WMI → manufacturer guess
WMI_MAKES = {
    # Ford
    "1FA": "Ford",
    "1FB": "Ford",
    "1FZ": "Ford",
    "3FA": "Ford (Mexico)",
    "1FT": "Ford Truck",
    "1FM": "Ford SUV",
    "3FM": "Ford SUV (Mexico)",
    # GM
    "1G1": "Chevrolet",
    "1G2": "Pontiac",
    "1G3": "Oldsmobile",
    "1G4": "Buick",
    "1G6": "Cadillac",
    "2G1": "Chevrolet (Canada)",
    "3G1": "Chevrolet (Mexico)",
    # Nissan
    "1N4": "Nissan",
    "1N6": "Nissan Truck",
    "3N1": "Nissan (Mexico)",
    "3N6": "Nissan Truck (Mexico)",
    "JN1": "Nissan (Japan)",
    "JN8": "Nissan SUV (Japan)",
    # Toyota
    "JT2": "Toyota (Japan)",
    "JT3": "Toyota SUV/Truck (Japan)",
    "2T1": "Toyota (Canada)",
    "4T1": "Toyota (USA)",
    # Subaru
    "JF1": "Subaru (Japan)",
    "4S3": "Subaru (USA)",
    # Chrysler/Dodge/Jeep
    "1C3": "Chrysler",
    "1C4": "Chrysler/Jeep",
    "1D3": "Dodge",
    "3D3": "Dodge (Mexico)",
}


def vin_clean(raw: str) -> str:
    return raw.strip().upper().replace(" ", "")


def vin_valid_chars(v: str) -> bool:
    # VINs cannot contain I, O, Q
    bad = set("IOQ")
    return not any(c in bad for c in v)


def vin_check_digit(vin: str):
    """Return (expected_digit_char, matches_bool or None if can't calc)."""
    if len(vin) != 17:
        return (None, None)
    try:
        total = 0
        for i, ch in enumerate(vin):
            if ch not in VIN_MAP:
                return (None, None)
            value = VIN_MAP[ch]
            weight = VIN_WEIGHTS[i]
            total += value * weight
        remainder = total % 11
        if remainder == 10:
            expected = "X"
        else:
            expected = str(remainder)
        actual = vin[8]
        return (expected, actual == expected)
    except Exception:
        return (None, None)


def vin_region(vin: str):
    return REGION_MAP.get(vin[0], "Unknown")


def vin_make(vin: str):
    wmi3 = vin[:3]
    return WMI_MAKES.get(wmi3, "Unknown")


def vin_model_year(vin: str):
    code = vin[9]
    # Try 2010+ interpretation first, then fallback to 1980s/90s
    # Simple guess based on current era
    key2 = code + "2"
    if key2 in YEAR_CODES:
        return YEAR_CODES[key2]
    return YEAR_CODES.get(code, None)


def main():
    print(f"{CYAN}{'=' * 60}{RESET}")
    print(f"{BOLD}{CYAN}           GOOD 'NUFF VIN HELPER{RESET}")
    print(f"{CYAN}{'=' * 60}{RESET}\n")

    if len(sys.argv) > 1:
        raw = " ".join(sys.argv[1:])
    else:
        raw = input("Enter VIN (17 characters): ")

    vin = vin_clean(raw)

    print(f"\nVIN: {BOLD}{vin}{RESET}")

    if len(vin) != 17:
        print(f"{RED}ERROR:{RESET} VIN must be 17 characters.")
        sys.exit(1)

    if not vin_valid_chars(vin):
        print(f"{YELLOW}Warning:{RESET} VIN contains I, O, or Q (usually invalid).")

    region = vin_region(vin)
    make = vin_make(vin)
    year = vin_model_year(vin)
    plant = vin[10]
    serial = vin[11:]

    expected, matches = vin_check_digit(vin)

    print("\nBasic decode:")
    print(f"  Region       : {region}")
    print(f"  WMI (1-3)    : {vin[:3]}  →  {make}")
    if year:
        print(f"  Model year   : {year} (from 10th char '{vin[9]}')")
    else:
        print(f"  Model year   : Unknown (10th char '{vin[9]}')")
    print(f"  Plant code   : {plant}")
    print(f"  Serial       : {serial}")

    print("\nCheck digit:")
    if expected is None:
        print(f"  {YELLOW}Could not compute check digit (invalid characters).{RESET}")
    else:
        actual = vin[8]
        status = (
            f"{GREEN}OK{RESET}" if matches else f"{RED}MISMATCH{RESET}"
        )
        print(f"  Calculated   : {expected}")
        print(f"  VIN digit    : {actual}")
        print(f"  Status       : {status}")

    # NHTSA URL suggestion
    nhtsa_url = f"https://vpic.nhtsa.dot.gov/decoder/Decoder/Decode?VIN={vin}"
    print(f"\nFor full decode, you can use NHTSA:")
    print(f"  {CYAN}{nhtsa_url}{RESET}")

    choice = input("\nOpen NHTSA VIN decoder in browser? [y/N]: ").strip().lower()
    if choice == "y":
        try:
            webbrowser.open(nhtsa_url)
            print(f"{GREEN}Opened in browser.{RESET}")
        except Exception as e:
            print(f"{RED}Could not open browser:{RESET} {e}")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nExiting VIN helper...")