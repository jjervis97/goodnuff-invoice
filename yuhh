#!/usr/bin/env bash
# GOOD 'NUFF FULL SHOP SYSTEM INSTALLER (FINAL)
# - Archives old ~/.business safely
# - Creates fresh structure
# - Installs CLI tools into ~/.local/bin
# - Adds PATH + aliases to ~/.zshrc
# - Includes weekly backup reminder logic

set -e

echo "=== GOOD 'NUFF SHOP INSTALL START ==="

HOME_DIR="$HOME"
BUS="$HOME_DIR/.business"
BIN="$HOME_DIR/.local/bin"
BACK_DIR="$HOME_DIR/.business_backups"

# 1) Archive old .business if it exists
if [ -d "$BUS" ]; then
  TS=$(date +%Y%m%d_%H%M%S)
  ARCHIVE_DIR="$HOME_DIR/.business_old_$TS"
  echo "Existing .business found. Moving it to:"
  echo "  $ARCHIVE_DIR"
  mv "$BUS" "$ARCHIVE_DIR"
else
  echo "No existing ~/.business folder to archive."
fi

# 2) Create fresh Good 'Nuff structure
echo
echo "Creating fresh Good 'Nuff business folders..."
mkdir -p "$BUS"
mkdir -p "$BUS/customers" "$BUS/jobs" "$BUS/.logs" "$BUS/archive" "$BUS/estimates"
mkdir -p "$BACK_DIR"
mkdir -p "$HOME_DIR/Outgoing"
mkdir -p "$BIN"

CUST_DIR="$BUS/customers"
CUST_DB="$CUST_DIR/customers.csv"
JOBS_DB="$BUS/jobs.csv"
MILE_DB="$BUS/mileage.csv"

# 3) Create CSVs
if [ ! -f "$CUST_DB" ]; then
  echo "customer_id,name,phone,email,vehicle,plate_or_vin,created_at" > "$CUST_DB"
fi

if [ ! -f "$JOBS_DB" ]; then
  echo "job_id,customer_id,customer_name,date,vehicle,job_desc,folder,mileage,status,invoice_id,estimate_id,total_labor,total_parts" > "$JOBS_DB"
fi

if [ ! -f "$MILE_DB" ]; then
  echo "entry_id,date,vehicle,plate_or_vin,customer_id,job_id,trip_miles,purpose" > "$MILE_DB"
fi

echo "Customer DB: $CUST_DB"
echo "Jobs DB:     $JOBS_DB"
echo "Mileage DB:  $MILE_DB"
echo


########################################
# Script: newjob
########################################
cat << 'EOF' > "$BIN/newjob"
#!/usr/bin/env bash
# Create a new customer job and folder structure (with quit/back)

set -e
BASE="$HOME/.business"
CUST_DIR="$BASE/customers"
JOBS_DIR="$BASE/jobs"
CUST_DB="$CUST_DIR/customers.csv"
JOBS_DB="$BASE/jobs.csv"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled. Nothing saved."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

mkdir -p "$CUST_DIR" "$JOBS_DIR"

echo "=== New Job ==="
echo "(Type 'q' to cancel or 'b' to go back at any time)"
echo

read -rp "Customer full name: " cust_name
quitcheck "$cust_name"
if [ -z "$cust_name" ]; then
  echo "Customer name is required."
  exit 1
fi

read -rp "Phone: " cust_phone
quitcheck "$cust_phone"

read -rp "Email: " cust_email
quitcheck "$cust_email"

read -rp "Vehicle (year make model): " vehicle
quitcheck "$vehicle"

read -rp "Plate or VIN (optional): " pov
quitcheck "$pov"

read -rp "Mileage (optional): " mileage
quitcheck "$mileage"

read -rp "Short job description: " job_desc
quitcheck "$job_desc"

# Clean commas out of fields so CSV doesn't break
cust_name_clean=$(echo "$cust_name" | sed 's/,/;/g')
vehicle_clean=$(echo "$vehicle" | sed 's/,/;/g')
job_desc_clean=$(echo "$job_desc" | sed 's/,/;/g')

cust_slug=$(echo "$cust_name_clean" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g; s/_\+/_/g; s/^_//; s/_$//')
[ -z "$cust_slug" ] && cust_slug="cust"

cust_id="$cust_slug"
created_at=$(date -Is)

# Ensure customer DB exists
if [ ! -f "$CUST_DB" ]; then
  echo "customer_id,name,phone,email,vehicle,plate_or_vin,created_at" > "$CUST_DB"
fi

# Add customer row if this ID is new
if ! grep -qi "^$cust_id," "$CUST_DB" 2>/dev/null; then
  printf '%s,"%s","%s","%s","%s","%s","%s"\n' \
    "$cust_id" "$cust_name_clean" "$cust_phone" "$cust_email" "$vehicle_clean" "$pov" "$created_at" >> "$CUST_DB"
fi

job_id=$(date +%Y%m%d_%H%M%S)
job_folder="${JOBS_DIR}/${cust_slug}_${job_id}"
mkdir -p "$job_folder"/{photos,diagnostics,docs,invoice}

job_date=$(date +%Y-%m-%d)

# Ensure jobs DB exists
if [ ! -f "$JOBS_DB" ]; then
  echo "job_id,customer_id,customer_name,date,vehicle,job_desc,folder,mileage,status,invoice_id,estimate_id,total_labor,total_parts" > "$JOBS_DB"
fi

status="open"
invoice_id=""
estimate_id=""
total_labor=""
total_parts=""

printf '%s,%s,"%s",%s,"%s","%s","%s","%s","%s","%s","%s","%s","%s"\n' \
  "$job_id" "$cust_id" "$cust_name_clean" "$job_date" "$vehicle_clean" "$job_desc_clean" "$job_folder" "$mileage" "$status" "$invoice_id" "$estimate_id" "$total_labor" "$total_parts" >> "$JOBS_DB"

cat > "$job_folder/meta.txt" <<META
Customer: $cust_name
Phone: $cust_phone
Email: $cust_email
Vehicle: $vehicle
Plate/VIN: $pov
Mileage: $mileage
Job description: $job_desc
Job ID: $job_id
Job date: $job_date
Folder: $job_folder
Status: $status
META

touch "$job_folder/notes.txt"

echo
echo "Job created:"
echo "  ID:     $job_id"
echo "  Folder: $job_folder"
echo "Store photos in photos/, scanner exports in diagnostics/, and invoice files in invoice/."
EOF


########################################
# Script: addnote
########################################
cat << 'EOF' > "$BIN/addnote"
#!/usr/bin/env bash
# Add a timestamped note to a specific job (with quit/back)

set -e
BASE="$HOME/.business"
JOBS_DIR="$BASE/jobs"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

if [ ! -d "$JOBS_DIR" ]; then
  echo "No jobs directory found at $JOBS_DIR"
  exit 1
fi

echo "=== Add Job Note ==="
echo "(Type 'q' to cancel or 'b' to go back)"
read -rp "Search jobs by customer/vehicle/keyword: " q
quitcheck "$q"
if [ -z "$q" ]; then
  echo "Search text is required."
  exit 1
fi

mapfile -t matches < <(find "$JOBS_DIR" -maxdepth 1 -mindepth 1 -type d -printf '%P\n' | grep -i "$q" | sort | tail -n 20)

if [ "${#matches[@]}" -eq 0 ]; then
  echo "No matching jobs found for '$q'."
  exit 1
fi

echo
echo "Matching jobs:"
for i in "${!matches[@]}"; do
  idx=$((i+1))
  echo "[$idx] ${matches[$i]}"
done
echo

read -rp "Select job number: " choice
quitcheck "$choice"
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "${#matches[@]}" ]; then
  echo "Invalid selection."
  exit 1
fi

job_dir="${matches[$((choice-1))]}"
full_path="$JOBS_DIR/$job_dir"

echo
read -rp "Note text: " note
quitcheck "$note"
if [ -z "$note" ]; then
  echo "Empty note, nothing added."
  exit 0
fi

ts=$(date -Is)
echo "[$ts] $note" >> "$full_path/notes.txt"

echo "Note added to: $full_path/notes.txt"
EOF


########################################
# Script: diaglog
########################################
cat << 'EOF' > "$BIN/diaglog"
#!/usr/bin/env bash
# Create a diagnostic log (complaint/cause/correction + codes, TXT + optional PDF)

set -e
BASE="$HOME/.business"
JOBS_DIR="$BASE/jobs"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

if [ ! -d "$JOBS_DIR" ]; then
  echo "No jobs directory found at $JOBS_DIR"
  exit 1
fi

echo "=== Diagnostic Log ==="
echo "(Type 'q' to cancel or 'b' to go back)"
read -rp "Search jobs by customer/vehicle/keyword: " q
quitcheck "$q"
if [ -z "$q" ]; then
  echo "Search text is required."
  exit 1
fi

mapfile -t matches < <(find "$JOBS_DIR" -maxdepth 1 -mindepth 1 -type d -printf '%P\n' | grep -i "$q" | sort | tail -n 20)

if [ "${#matches[@]}" -eq 0 ]; then
  echo "No matching jobs found for '$q'."
  exit 1
fi

echo
echo "Matching jobs:"
for i in "${!matches[@]}"; do
  idx=$((i+1))
  echo "[$idx] ${matches[$i]}"
done
echo

read -rp "Select job number: " choice
quitcheck "$choice"
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "${#matches[@]}" ]; then
  echo "Invalid selection."
  exit 1
fi

job_dir="${matches[$((choice-1))]}"
full_path="$JOBS_DIR/$job_dir"

echo
read -rp "Customer concern / complaint: " complaint
quitcheck "$complaint"
read -rp "Findings / cause: " cause
quitcheck "$cause"
read -rp "Work performed / correction: " correction
quitcheck "$correction"
read -rp "Codes (DTCs) if any: " codes
quitcheck "$codes"
read -rp "Mileage at time of visit: " mileage
quitcheck "$mileage"
read -rp "Recommendations / future work: " recs
quitcheck "$recs"
read -rp "Labor total (optional, just number): " labor
quitcheck "$labor"
read -rp "Parts total (optional, just number): " parts
quitcheck "$parts"

mkdir -p "$full_path/diagnostics"
diag_file="$full_path/diagnostics/diag_$(date +%Y%m%d_%H%M%S).txt"

cat > "$diag_file" <<LOG
GOOD 'NUFF MOBILE MECHANIC - DIAGNOSTIC REPORT
Date: $(date)
Job folder: $full_path

Complaint:
$complaint

Cause / Findings:
$cause

Work Performed / Correction:
$correction

Diagnostic Trouble Codes:
$codes

Mileage:
$mileage

Labor Total:
$labor

Parts Total:
$parts

Recommendations:
$recs
LOG

echo
echo "Diagnostic log saved to:"
echo "  $diag_file"

# Optional: create PDF if enscript + ps2pdf are available
if command -v enscript >/dev/null 2>&1 && command -v ps2pdf >/dev/null 2>&1; then
  pdf_file="${diag_file%.txt}.pdf"
  if enscript "$diag_file" -o - | ps2pdf - "$pdf_file"; then
    echo "PDF copy saved to:"
    echo "  $pdf_file"
  else
    echo "Tried to create PDF, but something failed. TXT report is still good."
  fi
else
  echo "PDF tools not found (enscript/ps2pdf). TXT report only."
fi
EOF


########################################
# Script: estimatenew
########################################
cat << 'EOF' > "$BIN/estimatenew"
#!/usr/bin/env bash
# Create a simple estimate file for a job

set -e
BASE="$HOME/.business"
JOBS_DIR="$BASE/jobs"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

if [ ! -d "$JOBS_DIR" ]; then
  echo "No jobs directory found at $JOBS_DIR"
  exit 1
fi

echo "=== New Estimate ==="
echo "(Type 'q' to cancel or 'b' to go back)"
read -rp "Search jobs by customer/vehicle/keyword: " q
quitcheck "$q"
if [ -z "$q" ]; then
  echo "Search text is required."
  exit 1
fi

mapfile -t matches < <(find "$JOBS_DIR" -maxdepth 1 -mindepth 1 -type d -printf '%P\n' | grep -i "$q" | sort | tail -n 20)

if [ "${#matches[@]}" -eq 0 ]; then
  echo "No matching jobs found for '$q'."
  exit 1
fi

echo
echo "Matching jobs:"
for i in "${!matches[@]}"; do
  idx=$((i+1))
  echo "[$idx] ${matches[$i]}"
done
echo

read -rp "Select job number: " choice
quitcheck "$choice"
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "${#matches[@]}" ]; then
  echo "Invalid selection."
  exit 1
fi

job_dir="${matches[$((choice-1))]}"
full_path="$JOBS_DIR/$job_dir"

echo
read -rp "Estimate summary (e.g. 'Front brakes, oil change'): " summary
quitcheck "$summary"
read -rp "Labor estimate: " labor_est
quitcheck "$labor_est"
read -rp "Parts estimate: " parts_est
quitcheck "$parts_est"
read -rp "Notes / disclaimers: " notes
quitcheck "$notes"

mkdir -p "$full_path/docs"
est_file="$full_path/docs/estimate_$(date +%Y%m%d_%H%M%S).txt"

cat > "$est_file" <<EST
GOOD 'NUFF MOBILE MECHANIC - ESTIMATE
Date: $(date)
Job folder: $full_path

Estimate Summary:
$summary

Labor Estimate:
$labor_est

Parts Estimate:
$parts_est

Notes / Disclaimers:
$notes
EST

echo
echo "Estimate saved to:"
echo "  $est_file"
EOF


########################################
# Script: vehiclehistory
########################################
cat << 'EOF' > "$BIN/vehiclehistory"
#!/usr/bin/env bash
# Show job history filtered by customer or vehicle from jobs.csv (read-only)

set -e
BASE="$HOME/.business"
JOBS_DB="$BASE/jobs.csv"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

if [ ! -f "$JOBS_DB" ]; then
  echo "No jobs.csv found at $JOBS_DB"
  exit 1
fi

echo "=== Vehicle / Customer History ==="
echo "(Type 'q' to cancel or 'b' to go back)"
read -rp "Search by customer name, vehicle, or keyword: " q
quitcheck "$q"
if [ -z "$q" ]; then
  echo "Search text is required."
  exit 1
fi

echo
echo "Matches (date | status | customer | vehicle | job_desc | job_id):"
awk -F',' -v q="$(echo "$q" | tr '[:upper:]' '[:lower:]')" '
NR==1 { next }
{
  # columns: job_id,customer_id,customer_name,date,vehicle,job_desc,folder,mileage,status,invoice_id,estimate_id,total_labor,total_parts
  line = tolower($3 "," $5 "," $6 "," $9);
  if (line ~ q) {
    printf "%s | %s | %s | %s | %s | %s\n", $4, $9, $3, $5, $6, $1;
  }
}
' "$JOBS_DB"
EOF


########################################
# Script: custsearch
########################################
cat << 'EOF' > "$BIN/custsearch"
#!/usr/bin/env bash
# Search customers in customers.csv

set -e
BASE="$HOME/.business"
CUST_DB="$BASE/customers/customers.csv"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

if [ ! -f "$CUST_DB" ]; then
  echo "No customers.csv found at $CUST_DB"
  exit 1
fi

echo "=== Customer Search ==="
echo "(Type 'q' to cancel or 'b' to go back)"
read -rp "Search by name, phone, email, or vehicle: " q
quitcheck "$q"
if [ -z "$q" ]; then
  echo "Search text is required."
  exit 1
fi

echo
echo "Matches (id | name | phone | email | vehicle | plate/VIN):"
awk -F',' -v q="$(echo "$q" | tr '[:upper:]' '[:lower:]')" '
NR==1 { next }
{
  line = tolower($1 "," $2 "," $3 "," $4 "," $5 "," $6);
  if (line ~ q) {
    printf "%s | %s | %s | %s | %s | %s\n", $1, $2, $3, $4, $5, $6;
  }
}
' "$CUST_DB"
EOF


########################################
# Script: listjobs (open jobs)
########################################
cat << 'EOF' > "$BIN/listjobs"
#!/usr/bin/env bash
# List open jobs from jobs.csv

set -e
BASE="$HOME/.business"
JOBS_DB="$BASE/jobs.csv"

if [ ! -f "$JOBS_DB" ]; then
  echo "No jobs.csv found at $JOBS_DB"
  exit 1
fi

echo "=== Open Jobs ==="
echo "date | customer | vehicle | job_desc | status | job_id"
awk -F',' '
NR==1 { next }
{
  status = $9;
  if (status == "" || status == "open" || status == "Open") {
    printf "%s | %s | %s | %s | %s | %s\n", $4, $3, $5, $6, status, $1;
  }
}
' "$JOBS_DB"
EOF


########################################
# Script: weekjobs (jobs in last 7 days)
########################################
cat << 'EOF' > "$BIN/weekjobs"
#!/usr/bin/env bash
# List jobs from the last 7 days

set -e
BASE="$HOME/.business"
JOBS_DB="$BASE/jobs.csv"

if [ ! -f "$JOBS_DB" ]; then
  echo "No jobs.csv found at $JOBS_DB"
  exit 1
fi

today=$(date +%Y-%m-%d)
weekago=$(date -d '7 days ago' +%Y-%m-%d)

echo "=== Jobs in Last 7 Days ($weekago to $today) ==="
echo "date | customer | vehicle | job_desc | status | job_id"
awk -F',' -v start="$weekago" -v end="$today" '
NR==1 { next }
{
  d = $4;
  if (d >= start && d <= end) {
    printf "%s | %s | %s | %s | %s | %s\n", $4, $3, $5, $6, $9, $1;
  }
}
' "$JOBS_DB"
EOF


########################################
# Script: mileageadd
########################################
cat << 'EOF' > "$BIN/mileageadd"
#!/usr/bin/env bash
# Add a mileage entry

set -e
BASE="$HOME/.business"
MILE_DB="$BASE/mileage.csv"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

if [ ! -f "$MILE_DB" ]; then
  echo "entry_id,date,vehicle,plate_or_vin,customer_id,job_id,trip_miles,purpose" > "$MILE_DB"
fi

echo "=== Add Mileage Entry ==="
echo "(Type 'q' to cancel or 'b' to go back)"

read -rp "Vehicle (year make model): " vehicle
quitcheck "$vehicle"
read -rp "Plate or VIN: " pov
quitcheck "$pov"
read -rp "Customer ID (optional): " cust_id
quitcheck "$cust_id"
read -rp "Job ID (optional): " job_id
quitcheck "$job_id"
read -rp "Trip miles: " miles
quitcheck "$miles"
read -rp "Purpose (e.g., 'mobile diagnostic', 'parts run'): " purpose
quitcheck "$purpose"

entry_id=$(date +%Y%m%d_%H%M%S)
entry_date=$(date +%Y-%m-%d)

vehicle_clean=$(echo "$vehicle" | sed 's/,/;/g')
purpose_clean=$(echo "$purpose" | sed 's/,/;/g')

printf '%s,%s,"%s","%s","%s","%s","%s","%s"\n' \
  "$entry_id" "$entry_date" "$vehicle_clean" "$pov" "$cust_id" "$job_id" "$miles" "$purpose_clean" >> "$MILE_DB"

echo "Mileage entry recorded."
EOF


########################################
# Script: bizbackup
########################################
cat << 'EOF' > "$BIN/bizbackup"
#!/usr/bin/env bash
# Backup .business and Outgoing into a timestamped tar.gz and log last backup time

set -e
BUS="$HOME/.business"
OUTGOING="$HOME/Outgoing"
BACK_DIR="$HOME/.business_backups"
LAST_FILE="$BUS/.last_backup"

mkdir -p "$BACK_DIR"

ts=$(date +%Y%m%d_%H%M%S)
backup_file="$BACK_DIR/goodnuff_business_$ts.tar.gz"

echo "=== Business Backup ==="
echo "Creating backup..."
tar -czf "$backup_file" "$BUS" "$OUTGOING"

echo "Backup created:"
echo "  $backup_file"

date +%s > "$LAST_FILE"
echo "Last backup timestamp updated."
EOF


########################################
# Script: taxexport
########################################
cat << 'EOF' > "$BIN/taxexport"
#!/usr/bin/env bash
# Export jobs.csv to a tax CSV (optionally for a single year)

set -e
BASE="$HOME/.business"
JOBS_DB="$BASE/jobs.csv"

quitcheck() {
  case "$1" in
    q|Q)
      echo "Cancelled."
      exit 0
      ;;
    b|B)
      echo "Back to menu."
      exit 0
      ;;
  esac
}

if [ ! -f "$JOBS_DB" ]; then
  echo "No jobs.csv found at $JOBS_DB"
  exit 1
fi

echo "=== Tax CSV Export ==="
echo "(Type 'q' to cancel or 'b' to go back)"
read -rp "Year (YYYY, blank for ALL): " year
quitcheck "$year"

ts=$(date +%Y%m%d_%H%M%S)

if [ -z "$year" ]; then
  out="$BASE/tax_export_all_$ts.csv"
  cp "$JOBS_DB" "$out"
  echo "Tax export (all years) saved to:"
  echo "  $out"
else
  out="$BASE/tax_export_${year}_$ts.csv"
  {
    head -n 1 "$JOBS_DB"
    awk -F',' -v y="$year" 'NR>1 { if (substr($4,1,4)==y) print }' "$JOBS_DB"
  } > "$out"
  echo "Tax export for year $year saved to:"
  echo "  $out"
fi

echo "Note: totals depend on what you record in invoices/diagnostic logs."
EOF


########################################
# Script: gn (Good 'Nuff menu with weekly backup reminder)
########################################
cat << 'EOF' > "$BIN/gn"
#!/usr/bin/env bash
# Good 'Nuff main business menu (standard mode, no full-screen clear)

BIN="$HOME/.local/bin"
BUS="$HOME/.business"
LAST_FILE="$BUS/.last_backup"

check_weekly_backup() {
  if [ -f "$LAST_FILE" ]; then
    last_ts=$(cat "$LAST_FILE" 2>/dev/null || echo "")
  else
    last_ts=""
  fi

  now_ts=$(date +%s)

  if [ -n "$last_ts" ]; then
    diff=$(( (now_ts - last_ts) / 86400 ))
    if [ "$diff" -ge 7 ]; then
      echo
      echo ">>> It has been $diff day(s) since your last backup."
      read -rp "Run bizbackup now? [y/N]: " ans
      case "$ans" in
        y|Y)
          "$BIN/bizbackup"
          ;;
        *)
          echo "Skipping backup for now."
          ;;
      esac
      echo
    fi
  else
    echo
    echo ">>> No backup record found. Consider running 'bizbackup'."
    echo
  fi
}

while true; do
  echo "====================================="
  echo "   GOOD 'NUFF MOBILE MECHANIC - GN   "
  echo "====================================="
  echo "1) Create new job"
  echo "2) Add note to job"
  echo "3) Create diagnostic log"
  echo "4) Create estimate"
  echo "5) View vehicle/customer history"
  echo "6) List open jobs"
  echo "7) Jobs in last 7 days"
  echo "8) Search customers"
  echo "9) Add mileage entry"
  echo "10) Run business backup"
  echo "11) Export tax CSV"
  echo "12) Show Outgoing folder path"
  echo "13) Quit"
  echo "-------------------------------------"
  read -rp "Choose an option [1-13]: " choice

  case "$choice" in
    1) "$BIN/newjob" ;;
    2) "$BIN/addnote" ;;
    3) "$BIN/diaglog" ;;
    4) "$BIN/estimatenew" ;;
    5) "$BIN/vehiclehistory" ;;
    6) "$BIN/listjobs" ;;
    7) "$BIN/weekjobs" ;;
    8) "$BIN/custsearch" ;;
    9) "$BIN/mileageadd" ;;
    10) "$BIN/bizbackup" ;;
    11) "$BIN/taxexport" ;;
    12) echo "Your Outgoing folder is: $HOME/Outgoing" ;;
    13) echo "Goodbye."; exit 0 ;;
    q|Q) echo "Goodbye."; exit 0 ;;
    *) echo "Invalid option." ;;
  esac

  check_weekly_backup
  echo
done
EOF


# 4) Make scripts executable
chmod +x "$BIN/newjob" "$BIN/addnote" "$BIN/diaglog" "$BIN/estimatenew" \
           "$BIN/vehiclehistory" "$BIN/custsearch" "$BIN/listjobs" \
           "$BIN/weekjobs" "$BIN/mileageadd" "$BIN/bizbackup" "$BIN/taxexport" "$BIN/gn"

# 5) Ensure ~/.local/bin is in PATH and aliases exist in .zshrc
ZSHRC="$HOME_DIR/.zshrc"

if ! grep -q ".local/bin" "$ZSHRC" 2>/dev/null; then
  {
    echo ""
    echo "# Ensure local bin in PATH (Good 'Nuff shop)"
    echo "export PATH=\"$HOME_DIR/.local/bin:\$PATH\""
  } >> "$ZSHRC"
  echo "Added ~/.local/bin to PATH in $ZSHRC"
fi

if ! grep -q "Good 'Nuff business aliases" "$ZSHRC" 2>/dev/null; then
  {
    echo ""
    echo "# Good 'Nuff business aliases"
    echo "alias gn='$HOME_DIR/.local/bin/gn'"
    echo "alias newjob='$HOME_DIR/.local/bin/newjob'"
    echo "alias addnote='$HOME_DIR/.local/bin/addnote'"
    echo "alias diaglog='$HOME_DIR/.local/bin/diaglog'"
    echo "alias estimatenew='$HOME_DIR/.local/bin/estimatenew'"
    echo "alias vehiclehistory='$HOME_DIR/.local/bin/vehiclehistory'"
    echo "alias custsearch='$HOME_DIR/.local/bin/custsearch'"
    echo "alias listjobs='$HOME_DIR/.local/bin/listjobs'"
    echo "alias weekjobs='$HOME_DIR/.local/bin/weekjobs'"
    echo "alias mileageadd='$HOME_DIR/.local/bin/mileageadd'"
    echo "alias bizbackup='$HOME_DIR/.local/bin/bizbackup'"
    echo "alias taxexport='$HOME_DIR/.local/bin/taxexport'"
  } >> "$ZSHRC"
  echo "Added Good 'Nuff aliases to $ZSHRC"
fi

echo
echo "=== GOOD 'NUFF SHOP INSTALL DONE ==="
echo "Old data (including invoices/code) is archived under ~/.business_old_TIMESTAMP"
echo "Now run:  source ~/.zshrc"
echo "Then run: gn"